name: ðŸ”µ Superbid - Scraper Completo

on:
  # ExecuÃ§Ã£o manual
  workflow_dispatch:
  
  # Cron automÃ¡tico - Todos os dias Ã s 5h UTC (2h BRT)
  schedule:
    - cron: '0 5 * * *'

jobs:
  superbid-scraper:
    name: ðŸ”µ Superbid - Scrape Completo
    runs-on: ubuntu-latest
    timeout-minutes: 240
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          pip install --no-cache-dir requests==2.31.0
      
      - name: âœ… Verificar instalaÃ§Ã£o
        run: |
          python -c "import requests; print('âœ… Requests OK')"
      
      - name: ðŸ”µ Executar scraper Superbid
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "========================================"
          echo "ðŸ”µ SUPERBID - SCRAPER COMPLETO"
          echo "========================================"
          echo "ðŸ“… InÃ­cio: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ‡§ðŸ‡· Brasil: $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S BRT')"
          echo "ðŸ“„ Modo: TODAS as pÃ¡ginas disponÃ­veis"
          echo "========================================"
          
          cd scrapers/superbid
          python scraper.py
          
          echo ""
          echo "âœ… ConcluÃ­do: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      
      - name: ðŸ’¾ Upload JSON (debug)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: superbid-data-${{ github.run_number }}
          path: scrapers/superbid/data/normalized/superbid_*.json
          retention-days: 3
      
      - name: ðŸ“Š Gerar resumo
        if: always()
        run: |
          echo "## ðŸ”µ Superbid - Resultado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**HorÃ¡rio UTC:** $(date -u '+%Y-%m-%d %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**HorÃ¡rio Brasil:** $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**Run #:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f scrapers/superbid/data/normalized/superbid_*.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Dados Coletados" >> $GITHUB_STEP_SUMMARY
            ITEM_COUNT=$(cat scrapers/superbid/data/normalized/superbid_*.json | grep -c '"external_id"' || echo "0")
            echo "- **Total de itens:** $ITEM_COUNT" >> $GITHUB_STEP_SUMMARY
          fi